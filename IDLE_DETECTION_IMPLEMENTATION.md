# üéØ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ—è (Idle Detection)

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Prisma Schema)**

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `idleThreshold` –≤ –º–æ–¥–µ–ª—å `Company` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 300 —Å–µ–∫—É–Ω–¥ = 5 –º–∏–Ω—É—Ç)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `idleDetectionEnabled` –≤ –º–æ–¥–µ–ª—å `Company` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `true`)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å `UserActivity` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ heartbeat –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 2. **API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã**

#### `POST /api/idle/heartbeat`

- –û—Ç–ø—Ä–∞–≤–∫–∞ heartbeat (—Å–∏–≥–Ω–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏) –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
- –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30-60 —Å–µ–∫—É–Ω–¥)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```json
{
  "isActive": true
}
```

#### `GET /api/idle/status`

- –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º heartbeat –∏ —Å—Ç–∞—Ç—É—Å–µ –ø—Ä–æ—Å—Ç–æ—è

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "isIdle": false,
  "lastHeartbeat": "2024-01-15T10:30:00.000Z",
  "secondsSinceLastHeartbeat": 45,
  "idleThreshold": 300
}
```

### 3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏**

#### `GET /api/companies/idle-detection-settings`

- –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ—è –∫–æ–º–ø–∞–Ω–∏–∏

#### `PATCH /api/companies/idle-detection-settings`

- –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ—è (—Ç–æ–ª—å–∫–æ –¥–ª—è OWNER –∏ ADMIN)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```json
{
  "idleDetectionEnabled": true,
  "idleThreshold": 300
}
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**

- `idleThreshold`: –º–∏–Ω–∏–º—É–º 60 —Å–µ–∫—É–Ω–¥, –º–∞–∫—Å–∏–º—É–º 3600 —Å–µ–∫—É–Ω–¥ (1 —á–∞—Å)

### 4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞**

- ‚úÖ Cron job –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É (`@Cron(CronExpression.EVERY_MINUTE)`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ time entries
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏—Ç –Ω–∞ –ø–∞—É–∑—É time entry, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Å—Ç–æ–µ
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WebSocket —Å–æ–±—ã—Ç–∏–µ `idle:detected` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –∫–æ–º–ø–∞–Ω–∏–∏

### 5. **WebSocket —Å–æ–±—ã—Ç–∏—è**

- ‚úÖ –°–æ–±—ã—Ç–∏–µ `idle:detected` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–∞—É–∑–µ
- ‚úÖ –°–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ, time entry –∏ –ø—Ä–∏—á–∏–Ω–µ –ø–∞—É–∑—ã

**–ü—Ä–∏–º–µ—Ä —Å–æ–±—ã—Ç–∏—è:**

```json
{
  "userId": "user-id",
  "timeEntryId": "entry-id",
  "action": "paused",
  "reason": "idle",
  "timestamp": "2024-01-15T10:35:00.000Z"
}
```

## üìã –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ (Frontend)

1. **–û—Ç–ø—Ä–∞–≤–∫–∞ heartbeat:**

   ```javascript
   // –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 30-60 —Å–µ–∫—É–Ω–¥
   setInterval(async () => {
     await fetch("/api/idle/heartbeat", {
       method: "POST",
       headers: {
         Authorization: `Bearer ${token}`,
         "Content-Type": "application/json",
       },
       body: JSON.stringify({ isActive: true }),
     });
   }, 30000); // –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**

   ```javascript
   const response = await fetch("/api/idle/status", {
     headers: { Authorization: `Bearer ${token}` },
   });
   const status = await response.json();
   ```

3. **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ WebSocket —Å–æ–±—ã—Ç–∏—è:**
   ```javascript
   socket.on("idle:detected", (data) => {
     console.log("Time entry paused due to idle:", data);
     // –û–±–Ω–æ–≤–∏—Ç—å UI, –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
   });
   ```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–∏:

1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

   ```bash
   GET /api/companies/idle-detection-settings
   ```

2. –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
   ```bash
   PATCH /api/companies/idle-detection-settings
   {
     "idleDetectionEnabled": true,
     "idleThreshold": 300  // 5 –º–∏–Ω—É—Ç
   }
   ```

## üéØ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç heartbeat** –∫–∞–∂–¥—ã–µ 30-60 —Å–µ–∫—É–Ω–¥
2. **–°–µ—Ä–≤–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç** `UserActivity.lastHeartbeat`
3. **Cron job –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É:**
   - –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –¥–µ—Ç–µ–∫—Ü–∏–µ–π –ø—Ä–æ—Å—Ç–æ—è
   - –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ time entries
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–æ—Å—Ç–æ—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Å—Ç–æ–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–π heartbeat > `idleThreshold`):
     - –°—Ç–∞–≤–∏—Ç time entry –Ω–∞ –ø–∞—É–∑—É
     - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WebSocket —Å–æ–±—ã—Ç–∏–µ
     - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å `isIdle` –≤ `UserActivity`

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–µ—Ç–µ–∫—Ü–∏—è –ø—Ä–æ—Å—Ç–æ—è **–≤–∫–ª—é—á–µ–Ω–∞** –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ—Ä–æ–≥ –ø—Ä–æ—Å—Ç–æ—è: **300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥: **60 —Å–µ–∫—É–Ω–¥ (1 –º–∏–Ω—É—Ç–∞)**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥: **3600 —Å–µ–∫—É–Ω–¥ (1 —á–∞—Å)**
- Cron job —Ä–∞–±–æ—Ç–∞–µ—Ç **–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É**, –ø–æ—ç—Ç–æ–º—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–∞—É–∑—ã = 1 –º–∏–Ω—É—Ç–∞ + –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

```bash
# –í Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ
npx prisma db push
```

–ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:

```bash
npx prisma migrate dev --name add_idle_detection
```
