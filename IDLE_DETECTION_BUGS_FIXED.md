# üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏ –≤ –¥–µ—Ç–µ–∫—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ—è

## –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏

### üî¥ BUG 1: Race Condition –≤ `pauseTimeEntryIfIdle`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞—Ç—É—Å–∞ time entry –∏ –≤—ã–∑–æ–≤–æ–º `pause()` entry –º–æ–≥ –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–Ω–æ–≤–∏–ª —Ç–∞–π–º–µ—Ä).

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è Prisma –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Å—Ç–æ—è –∏ —Å—Ç–∞—Ç—É—Å–∞ entry
- –î–æ–±–∞–≤–ª–µ–Ω–∞ double-check –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Å—Ç–æ—è –ø–µ—Ä–µ–¥ –ø–∞—É–∑–æ–π
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `isIdle` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

### üî¥ BUG 2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `distinct` –≤ cron job
**–ü—Ä–æ–±–ª–µ–º–∞:** `distinct: ['userId']` –≤ Prisma –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –£–±—Ä–∞–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `distinct`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `findMany` —Å –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ `Set`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ `Promise.allSettled` –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

### üü° BUG 3: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `pauseTimeEntryIfIdle`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `pause()` –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, entry —É–∂–µ –Ω–µ RUNNING), –æ—à–∏–±–∫–∞ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω try-catch –≤–æ–∫—Ä—É–≥ –≤—ã–∑–æ–≤–∞ `pause()`
- –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ (entry —É–∂–µ –Ω–µ RUNNING, entry –Ω–µ –Ω–∞–π–¥–µ–Ω–æ) –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ debug
- –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ warning
- –ú–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `false` –≤–º–µ—Å—Ç–æ –≤—ã–±—Ä–∞—Å—ã–≤–∞–Ω–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è

### üü° BUG 4: –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `isIdle` –ø—Ä–∏ heartbeat
**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏–∫–∞ `isIdle: dto.isActive === false ? true : false` –±—ã–ª–∞ –∏–∑–±—ã—Ç–æ—á–Ω–æ–π –∏ –º–æ–≥–ª–∞ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞: `isIdle: dto.isActive === false`
- –ï—Å–ª–∏ `isActive` –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ `true`, `isIdle` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `false`
- –ï—Å–ª–∏ `isActive === false`, `isIdle` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `true`

### üü° BUG 5: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è UserActivity
**–ü—Ä–æ–±–ª–µ–º–∞:** –í `pauseTimeEntryIfIdle` –æ–±–Ω–æ–≤–ª—è–ª—Å—è `UserActivity`, –Ω–æ –∑–∞–ø–∏—Å—å –º–æ–≥–ª–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è `UserActivity` –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å), –º–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null` –∏ –Ω–µ —Å—Ç–∞–≤–∏—Ç –Ω–∞ –ø–∞—É–∑—É

### üü° BUG 6: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ idle detection –∫—ç—à –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–ª—Å—è.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ `company:${companyId}:settings` –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫

### üü° BUG 7: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ `getUserActivityStatus`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏ `lastHeartbeat` –≤ –±—É–¥—É—â–µ–º, `secondsSinceLastHeartbeat` –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞: `safeSecondsSinceLastHeartbeat = secondsSinceLastHeartbeat < 0 ? 0 : secondsSinceLastHeartbeat`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Å—Ç–æ—è

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ cron job:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `Promise.allSettled` –≤–º–µ—Å—Ç–æ `Promise.all`
   - –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

2. **–£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ cron job
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

3. **–£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –î–æ–±–∞–≤–ª–µ–Ω—ã debug –ª–æ–≥–∏ –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (entry —É–∂–µ –Ω–µ RUNNING)
   - Warning –ª–æ–≥–∏ –¥–ª—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
   - Error –ª–æ–≥–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

1. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç heartbeat ‚Üí entry –Ω–µ —Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∞ –ø–∞—É–∑—É
2. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç heartbeat ‚Üí entry —Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∞ –ø–∞—É–∑—É —á–µ—Ä–µ–∑ `idleThreshold`
3. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç entry –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Å—Ç–æ—è ‚Üí –æ—à–∏–±–∫–∞ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç
4. ‚úÖ –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
5. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ idle detection ‚Üí –∫—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è
6. ‚úÖ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ heartbeat ‚Üí entry –Ω–µ —Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∞ –ø–∞—É–∑—É

