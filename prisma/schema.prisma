// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                        String   @id @default(uuid())
  name                      String
  domain                    String?  @unique
  screenshotEnabled        Boolean  @default(true)
  screenshotInterval       Int      @default(60) // in seconds: 30, 60, 300, 600 (legacy)
  screenshotIntervalMinutes Int      @default(10) // Desktop app: interval in minutes
  allowBlurScreenshots      Boolean  @default(true) // Desktop app: allow blurring screenshots
  idleThreshold             Int      @default(300) // in seconds: время простоя до автоматической паузы (default 5 minutes)
  idleTimeoutMinutes        Int      @default(5) // Desktop app: idle timeout in minutes
  idleDetectionEnabled      Boolean  @default(true) // включена ли детекция простоя
  trackAppsAndUrls          Boolean  @default(true) // Desktop app: track app and URL activity
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  users       User[]
  projects    Project[]
  blockedUrls BlockedUrl[]
  invitations Invitation[]

  @@map("companies")
}

model User {
  id                String     @id @default(uuid())
  name              String
  email             String
  password          String
  avatar            String?
  role              UserRole   @default(EMPLOYEE)
  status            UserStatus @default(ACTIVE)
  hourlyRate        Float?
  companyId         String
  passwordChangedAt DateTime? // Дата последней смены пароля
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  company             Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntries         TimeEntry[]
  approvedTimeEntries TimeEntry[]          @relation("ApprovedTimeEntries")
  activities          Activity[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  userActivity        UserActivity?
  appActivities       AppActivity[]
  urlActivities       UrlActivity[]
  notifications       Notification[]
  invitationsSent     Invitation[]

  @@unique([email, companyId])
  @@index([companyId])
  @@map("users")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  companyId String
  type      NotificationType
  title     String
  message   String
  readAt    DateTime?
  metadata  Json? // { timeEntryId?, actorId?, actorName?, projectId?, projectName?, rejectionComment? }
  createdAt DateTime        @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@index([userId, readAt])
  @@index([createdAt])
  @@map("notifications")
}

model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  color       String        @default("#3b82f6")
  clientName  String?
  budget      Float?
  status      ProjectStatus @default(ACTIVE)
  companyId   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  timeEntries TimeEntry[]
  activities  Activity[]

  @@index([companyId])
  @@map("projects")
}

model TimeEntry {
  id               String         @id @default(uuid())
  userId           String
  projectId        String?
  startTime        DateTime
  endTime          DateTime?
  duration         Int            @default(0) // in seconds
  description      String?
  status           EntryStatus    @default(RUNNING)
  approvalStatus   ApprovalStatus @default(PENDING)
  approvedBy       String?
  approvedAt       DateTime?
  rejectionComment String?
  idempotencyKey   String?        @unique // client-generated UUID for sync deduplication
  timezone         String?        // IANA timezone (e.g. "Europe/Moscow")
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  project        Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  approvedByUser User?         @relation("ApprovedTimeEntries", fields: [approvedBy], references: [id], onDelete: SetNull)
  screenshots    Screenshot[]
  appActivities  AppActivity[]
  urlActivities  UrlActivity[]

  @@index([userId])
  @@index([projectId])
  @@index([startTime])
  @@index([status])
  @@index([approvalStatus])
  @@index([userId, status])
  @@index([userId, startTime])
  @@map("time_entries")
}

model Activity {
  id        String       @id @default(uuid())
  userId    String
  projectId String?
  type      ActivityType
  timestamp DateTime     @default(now())
  createdAt DateTime     @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([timestamp])
  @@map("activities")
}

model Screenshot {
  id           String   @id @default(uuid())
  timeEntryId  String
  imageUrl     String // путь к файлу или base64
  thumbnailUrl String? // путь к миниатюре
  timestamp    DateTime @default(now())
  createdAt    DateTime @default(now())

  timeEntry TimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)

  @@index([timeEntryId])
  @@index([timestamp])
  @@map("screenshots")
}

model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  email     String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model UserActivity {
  id            String   @id @default(uuid())
  userId        String   @unique
  lastHeartbeat DateTime @default(now())
  isIdle        Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastHeartbeat])
  @@index([isIdle])
  @@map("user_activities")
}

model AppActivity {
  id          String    @id @default(uuid())
  timeEntryId String
  userId      String
  appName     String // название приложения (например, "Visual Studio Code")
  windowTitle String? // заголовок окна (например, "index.ts - Hubnity")
  timeSpent   Int       @default(0) // время использования в секундах
  startTime   DateTime  @default(now()) // время начала использования приложения
  endTime     DateTime? // время окончания использования приложения
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  timeEntry TimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([timeEntryId])
  @@index([userId])
  @@index([appName])
  @@index([startTime])
  @@index([userId, startTime])
  @@map("app_activities")
}

model UrlActivity {
  id          String    @id @default(uuid())
  timeEntryId String
  userId      String
  url         String // Полный URL
  domain      String // Домен (например, "github.com")
  title       String? // Заголовок страницы
  timeSpent   Int       @default(0) // время использования в секундах
  startTime   DateTime  @default(now()) // время начала использования URL
  endTime     DateTime? // время окончания использования URL
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  timeEntry TimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([timeEntryId])
  @@index([userId])
  @@index([domain])
  @@index([startTime])
  @@index([userId, startTime])
  @@map("url_activities")
}

model BlockedUrl {
  id        String   @id @default(uuid())
  companyId String
  url       String? // Конкретный URL (опционально, для точной блокировки)
  domain    String? // Домен (опционально, для блокировки всего домена)
  pattern   String? // Regex паттерн (опционально, для сложных правил)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([domain])
  @@map("blocked_urls")
}

enum UserRole {
  SUPER_ADMIN
  OWNER
  ADMIN
  MANAGER
  EMPLOYEE
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
}

enum EntryStatus {
  RUNNING
  PAUSED
  STOPPED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ActivityType {
  START
  STOP
  PAUSE
  RESUME
}

enum NotificationType {
  TIME_ENTRY_APPROVED
  TIME_ENTRY_REJECTED
  TIME_ENTRY_PENDING_APPROVAL
  USER_ADDED
}

model Invitation {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  companyId String
  role      UserRole @default(EMPLOYEE)
  expiresAt DateTime
  inviterId String?
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inviter User?   @relation(fields: [inviterId], references: [id], onDelete: SetNull)

  @@index([token])
  @@index([companyId])
  @@index([expiresAt])
  @@map("invitations")
}
