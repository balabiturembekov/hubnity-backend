# Найденные баги в модуле Team Activity

## Итоги проверки

### Найдено 8 багов

## Детальный список багов

### BUG 62: Отсутствие валидации UUID для входных параметров

**Файл**: `src/team-activity/team-activity.service.ts`

**Проблема**:

- Не проверяется формат UUID для `companyId`, `userId`, `query.userId`, `query.projectId`
- Может привести к ошибкам базы данных при невалидных UUID

**Риск**: Ошибки базы данных, потенциальные SQL-инъекции (хотя Prisma защищает)

**Исправление**: Добавить валидацию UUID формата перед запросами к базе данных

---

### BUG 63: Отсутствие проверки существования компании

**Файл**: `src/team-activity/team-activity.service.ts`

**Проблема**:

- Не проверяется существование компании перед выполнением запросов
- Может привести к ошибкам или возврату пустых данных для несуществующей компании

**Исправление**: Добавить проверку существования компании в начале метода

---

### BUG 64: Отсутствие проверки прав доступа для сотрудников

**Файл**: `src/team-activity/team-activity.service.ts`

**Проблема**:

- Сотрудники могут передать `query.userId` и получить данные других пользователей
- Логика `effectiveUserId = isEmployee ? userId : query.userId` не предотвращает это

**Риск**: Утечка данных - сотрудники могут видеть активность других пользователей

**Исправление**: Добавить проверку, что сотрудники не могут использовать `query.userId`

---

### BUG 65: Race condition при проверке пользователя и проекта

**Файл**: `src/team-activity/team-activity.service.ts`

**Проблема**:

- Проверка существования пользователя/проекта выполняется отдельно от основного запроса
- Между проверкой и запросом данные могут измениться (пользователь удален, проект удален)

**Исправление**: Использовать транзакцию или проверять в основном запросе через where условия

---

### BUG 66: Отсутствие проверки статуса пользователя при фильтрации

**Файл**: `src/team-activity/team-activity.service.ts`

**Проблема**:

- При проверке `userCheck` не проверяется статус пользователя
- Неактивный пользователь может быть включен в результаты

**Исправление**: Добавить проверку `status: "ACTIVE"` в `userCheck`

---

### BUG 67: Отсутствие лимита на количество записей timeEntries

**Файл**: `src/team-activity/team-activity.service.ts`

**Проблема**:

- Запрос `timeEntry.findMany` не имеет лимита
- При большом количестве записей может привести к проблемам с памятью

**Исправление**: Добавить `take: 10000` для ограничения количества записей

---

### BUG 68: Отсутствие валидации диапазона дат для CUSTOM периода

**Файл**: `src/team-activity/team-activity.service.ts`

**Проблема**:

- Не проверяется максимальный диапазон дат для `CUSTOM` периода
- Можно запросить данные за 100+ лет, что приведет к проблемам с производительностью

**Исправление**: Добавить проверку максимального диапазона (например, 10 лет)

---

### BUG 69: Отсутствие валидации hourlyRate на максимальное значение

**Файл**: `src/team-activity/team-activity.service.ts`

**Проблема**:

- Не проверяется максимальное значение `hourlyRate`
- Очень большое значение может привести к переполнению при расчете `earned`

**Исправление**: Добавить проверку максимального значения `hourlyRate` (например, 1,000,000)

---

## Статистика

- **Всего найдено**: 8 багов
- **Категории**:
  - Безопасность: 2 бага (BUG 62, BUG 64)
  - Валидация: 3 бага (BUG 62, BUG 68, BUG 69)
  - Race conditions: 1 баг (BUG 65)
  - Производительность: 1 баг (BUG 67)
  - Логика: 2 бага (BUG 63, BUG 66)

## Приоритет исправления

1. **Высокий**: BUG 64 (утечка данных), BUG 62 (валидация UUID)
2. **Средний**: BUG 65 (race condition), BUG 66 (проверка статуса), BUG 63 (проверка компании)
3. **Низкий**: BUG 67 (лимит записей), BUG 68 (валидация дат), BUG 69 (валидация hourlyRate)
