# üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏ –≤ –¥–µ—Ç–µ–∫—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ—è (–†–∞—É–Ω–¥ 3)

## –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏

### üü° BUG 15: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ `checkUserIdle`
**–ü—Ä–æ–±–ª–µ–º–∞:** –í –º–µ—Ç–æ–¥–µ `checkUserIdle` –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª—Å—è —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ `lastHeartbeat` –≤ –±—É–¥—É—â–µ–º (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã), —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é –ø—Ä–æ—Å—Ç–æ—è.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: `safeSecondsSinceLastHeartbeat = secondsSinceLastHeartbeat < 0 ? 0 : secondsSinceLastHeartbeat`
- –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Å—Ç–æ—è

### üî¥ BUG 16: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ cron job
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π `Promise.allSettled` –º–æ–≥ —Å–æ–∑–¥–∞—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î, —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–±–ª–µ–º–∞–º —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω –±–∞—Ç—á–∏–Ω–≥: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±–∞—Ç—á–∞–º–∏ –ø–æ 10
- –ö–∞–∂–¥—ã–π –±–∞—Ç—á –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –Ω–æ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ
- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É –ë–î –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### üü° BUG 17: –î–≤–æ–π–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–ª–∏—Å—å, –∞ –∑–∞—Ç–µ–º —Å–Ω–æ–≤–∞ –≤—ã–±—Ä–∞—Å—ã–≤–∞–ª–∏—Å—å. –°–µ—Ä–≤–∏—Å —Ç–∞–∫–∂–µ –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –¥–≤–æ–π–Ω–æ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—é.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –£–±—Ä–∞–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
- –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–µ—Ä–≤–∏—Å–µ
- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –¥–∞–ª—å—à–µ

### üü° BUG 18: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ null/undefined –¥–ª—è `idleThreshold`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä `||` –≤–º–µ—Å—Ç–æ `??`, —á—Ç–æ –æ–∑–Ω–∞—á–∞–ª–æ, —á—Ç–æ –µ—Å–ª–∏ `idleThreshold` —Ä–∞–≤–µ–Ω `0` (—á—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ), –æ–Ω –∑–∞–º–µ–Ω—è–ª—Å—è –Ω–∞ `300`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –ó–∞–º–µ–Ω–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä `||` –Ω–∞ `??` –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö
- –¢–µ–ø–µ—Ä—å `0` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (—Ö–æ—Ç—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `0`)
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ `checkUserIdle`, `pauseTimeEntryIfIdle`, `getUserActivityStatus`

### üü° BUG 19: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è `result.entry` –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–æ—Å—å, —á—Ç–æ `result.entry` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤. –•–æ—Ç—è —ç—Ç–æ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–µ.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `if (!result.entry || !result.entry.id)` –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- –ï—Å–ª–∏ entry –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è warning –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `false`

### üü° BUG 20: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ `upsert` –≤ `handleHeartbeat`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `upsert` –Ω–µ —É–¥–∞–µ—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ constraint violation), –æ—à–∏–±–∫–∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω try-catch –≤–æ–∫—Ä—É–≥ `upsert`
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ `P2002` (Unique constraint violation)
- –ü—Ä–∏ —Ç–∞–∫–æ–π –æ—à–∏–±–∫–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å `update` –≤–º–µ—Å—Ç–æ `upsert`

### üü° BUG 21: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –≤ `getUserActivityStatus`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `company?.idleThreshold || 300`, —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —è–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏
- –ï—Å–ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å `null` –¥–ª—è `idleThreshold`
- `isIdle` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `false`, –µ—Å–ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

## –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 21 –±–∞–≥
- **–†–∞—É–Ω–¥ 1:** 7 –±–∞–≥–æ–≤ (race conditions, –ª–æ–≥–∏–∫–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
- **–†–∞—É–Ω–¥ 2:** 7 –±–∞–≥–æ–≤ (–≤–∞–ª–∏–¥–∞—Ü–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- **–†–∞—É–Ω–¥ 3:** 7 –±–∞–≥–æ–≤ (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, edge cases, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö)

## –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –±–∞–≥–æ–≤ (–†–∞—É–Ω–¥ 3)

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (1 –±–∞–≥)
- BUG 16: –ë–∞—Ç—á–∏–Ω–≥ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö (3 –±–∞–≥–∞)
- BUG 15: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- BUG 18: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `??` –≤–º–µ—Å—Ç–æ `||`
- BUG 21: –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (2 –±–∞–≥–∞)
- BUG 17: –î–≤–æ–π–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- BUG 20: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ upsert

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å/–í–∞–ª–∏–¥–∞—Ü–∏—è (1 –±–∞–≥)
- BUG 19: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è result.entry

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (100+) –≤ cron job
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã)
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É `idleThreshold = 0` (—Ö–æ—Ç—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç)
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É constraint violation –ø—Ä–∏ upsert
5. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫


